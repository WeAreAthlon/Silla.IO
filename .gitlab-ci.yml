stages:
  - build
  - test
  - report

variables:
  ENV_SILLA_ENVIRONMENT: ci
  MYSQL_DATABASE: silla_io
  MYSQL_ROOT_PASSWORD: dbs1cret

cache:
  paths:
    - vendor/

before_script:
  - apt-get update -yqq
  - apt-get install git libcurl4-gnutls-dev libjpeg-dev libpng-dev zlib1g-dev libfreetype6-dev libsqlite3-dev libpcre3-dev -yqq

  # Compile PHP, include these extensions.
  - docker-php-ext-install mbstring pdo_mysql curl json gd zip

  # Install and enable Xdebug
  - pecl install xdebug
  - docker-php-ext-enable xdebug

  # Install Composer and project dependencies.
  - curl -sS https://getcomposer.org/installer | php
  - php composer.phar install

# Build stage jobs

#build:php5.6:
#  image: php:5.6
#  stage: build
#  script:
#    - php composer.phar require --dev jakub-onderka/php-parallel-lint
#    - ./vendor/bin/parallel-lint --exclude vendor .
#    - php composer.phar require --dev squizlabs/php_codesniffer:2.9.0
#    - ./vendor/bin/phpcs --extensions=php --standard=PSR2 --ignore=vendor,public,temp .
#  cache:
#    untracked: true
#  only:
#    - develop
#    - master
#
#build:php7.0:
#  image: php:7.0
#  stage: build
#  script:
#    - php composer.phar require --dev jakub-onderka/php-parallel-lint
#    - ./vendor/bin/parallel-lint --exclude vendor .
#    - php composer.phar require --dev squizlabs/php_codesniffer:2.9.0
#    - ./vendor/bin/phpcs --extensions=php --standard=PSR2 --ignore=vendor,public,temp .
#  cache:
#    untracked: true
#  only:
#    - develop
#    - master
#
#build:php-latest:
#  image: php:latest
#  stage: build
#  script:
#    - php composer.phar require --dev jakub-onderka/php-parallel-lint
#    - ./vendor/bin/parallel-lint --exclude vendor .
#    - php composer.phar require --dev squizlabs/php_codesniffer:2.9.0
#    - ./vendor/bin/phpcs --extensions=php --standard=PSR2 --ignore=vendor,public,temp .
#  cache:
#    untracked: true
#  only:
#    - develop
#    - master

# Test Stage jobs
test:php5.6:mysql5.6:
  image: php:5.6
  stage: test
  dependencies:
    - build:php5.6
  services:
    - mysql:5.6
  script:
    - ./silla tasks:db:create ./resources/db/mysql/dump.mysql.sql
    - ./vendor/bin/phpunit --stderr --coverage-text --colors=never --configuration ./build/configurations/phpunit.xml
  only:
    - develop
    - master

#test:php7.0:mysql5.7:
#  image: php:7.0
#  stage: test
#  dependencies:
#    - build:php7.0
#  services:
#    - mysql:5.7
#  script:
#    - ./silla tasks:db:create ./resources/db/mysql/dump.mysql.sql
#    - ./vendor/bin/phpunit --stderr --coverage-text --colors=never --configuration ./build/configurations/phpunit.xml
#  only:
#    - develop
#    - master
#
#test:php-latest:mysql-latest:
#  image: php:latest
#  stage: test
#  dependencies:
#    - build:php-latest
#  services:
#    - mysql:latest
#  script:
#    - ./silla tasks:db:create ./resources/db/mysql/dump.mysql.sql
#    - ./vendor/bin/phpunit --stderr --coverage-text --colors=never --configuration ./build/configurations/phpunit.xml
#  only:
#    - develop
#    - master

#report:php5.6:
#  image: php:5.6
#  stage: report
#  allow_failure: true
#  dependencies:
#      - build:php-latest
#      - test:php5.6:mysql5.6
#  script:
#    - ./vendor/bin/apigen generate --quiet --config ./build/configurations/apigen.yaml
#    - ./vendor/bin/phploc --exclude vendor --exclude temp --exclude public --count-tests --log-csv ./build/logs/phploc.csv --log-xml ./build/logs/phploc.xml .
#    - ./vendor/bin/phpmd . html codesize --reportfile build/logs/pmd.html --exclude vendor,tests,temp,public --ignore-violations-on-exit
#    - ./vendor/bin/pdepend --jdepend-xml=build/logs/pdepend-jdepend.xml --jdepend-chart=build/logs/pdepend-dependencies.svg --overview-pyramid=build/logs/pdepend-overview-pyramid.svg --ignore=vendor,public,resources,temp .
##    - ./vendor/bin/phpcpd --log-pmd build/logs/pmd-cpd.xml --exclude vendor --exclude temp --exclude public .
#  artifacts:
#    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
#    paths:
#      - ./public/doc/
#      - ./build/logs/
#    expire_in: 1 week
#  cache:
#    untracked: true
#  only:
#    - master
#
#report:php7.0:
#  image: php:7.0
#  stage: report
#  allow_failure: true
#  dependencies:
#      - build:php-latest
#      - test:php7.0:mysql5.7
#  script:
#    - ./vendor/bin/apigen generate --quiet --config ./build/configurations/apigen.yaml
#    - ./vendor/bin/phploc --exclude vendor --exclude temp --exclude public --count-tests --log-csv ./build/logs/phploc.csv --log-xml ./build/logs/phploc.xml .
#    - ./vendor/bin/phpmd . html codesize --reportfile build/logs/pmd.html --exclude vendor,tests,temp,public --ignore-violations-on-exit
#    - ./vendor/bin/pdepend --jdepend-xml=build/logs/pdepend-jdepend.xml --jdepend-chart=build/logs/pdepend-dependencies.svg --overview-pyramid=build/logs/pdepend-overview-pyramid.svg --ignore=vendor,public,resources,temp .
##    - ./vendor/bin/phpcpd --log-pmd build/logs/pmd-cpd.xml --exclude vendor --exclude temp --exclude public .
#  artifacts:
#    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
#    paths:
#      - ./public/doc/
#      - ./build/logs/
#    expire_in: 1 week
#  cache:
#    untracked: true
#  only:
#    - master
#
#report:php-latest:
#  image: php:latest
#  stage: report
#  allow_failure: true
#  dependencies:
#      - build:php-latest
#      - test:php-latest:mysql-latest
#  script:
#    - ./vendor/bin/apigen generate --quiet --config ./build/configurations/apigen.yaml
#    - ./vendor/bin/phploc --exclude vendor --exclude temp --exclude public --count-tests --log-csv ./build/logs/phploc.csv --log-xml ./build/logs/phploc.xml .
#    - ./vendor/bin/phpmd . html codesize --reportfile build/logs/pmd.html --exclude vendor,tests,temp,public --ignore-violations-on-exit
#    - ./vendor/bin/pdepend --jdepend-xml=build/logs/pdepend-jdepend.xml --jdepend-chart=build/logs/pdepend-dependencies.svg --overview-pyramid=build/logs/pdepend-overview-pyramid.svg --ignore=vendor,public,resources,temp .
##    - ./vendor/bin/phpcpd --log-pmd build/logs/pmd-cpd.xml --exclude vendor --exclude temp --exclude public .
#  artifacts:
#    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
#    paths:
#      - ./public/doc/
#      - ./build/logs/
#    expire_in: 1 week
#  cache:
#    untracked: true
#  only:
#    - master